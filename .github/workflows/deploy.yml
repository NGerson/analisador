name: Implantar na VPS

on:
  push:
    branches:
      - master

jobs:
  implantar:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Verificar Segredos (Debug)
        run: |
          echo "Host: ${{ secrets.VPS_HOST }}"
          echo "Usuário: ${{ secrets.VPS_USERNAME }}"
          echo "Senha está presente: ${{ secrets.VPS_PASSWORD != '' }}"

      - name: Implantar na VPS
        uses: appleboy/ssh-action@v1.0.3 # Versão fixada para estabilidade
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          script: |
            set -e # Adiciona um comando para parar o script se algo der errado
            echo "Conectado ao servidor. Iniciando deploy..."
            cd /root/analisador
            echo "Puxando atualizações do repositório..."
            git pull
            echo "Ativando ambiente virtual..."
            source .venv/bin/activate
            echo "Instalando dependências..."
            pip install -r requirements.txt
            echo "Reiniciando o serviço..."
            sudo systemctl restart analisador
            echo "Deploy concluído com sucesso!"
