name: Deploy Contínuo no Servidor VPS

# 1. Gatilho (Trigger): Define quando o workflow deve rodar.
#    Roda sempre que houver um 'push' na branch 'main'.
on:
  push:
    branches:
      - main

# 2. Jobs: Define a(s) tarefa(s) que serão executadas.
jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # 3. Steps: A sequência de ações (passos) do Job.
    steps:
      # Passo 1: Faz o download do código do seu repositório para a máquina virtual
      - name: Checkout do Código
        uses: actions/checkout@v4

      # Passo 2: Implanta no servidor usando a ação de SSH
      - name: Implantar no servidor
        uses: appleboy/ssh-action@master
        with:
          # Host: O IP do seu VPS (31.97.95.109)
          host: 31.97.95.109
          
          # Usuário de login no VPS (confirmado como root)
          username: root
          
          # Porta SSH (padrão 22)
          port: 22 

          # CHAVE PRIVADA: Referencia o Secret no GitHub (agora sem passphrase)
          key: ${{ secrets.SSH_PRIVATE_KEY }} 

          # Comandos que serão executados no servidor após a conexão
          script: |
            echo "Iniciando processo de deploy no servidor..."
            
            # 1. NAVEGA PARA A PASTA CORRETA (confirmada em /var/www/analisador)
            cd /var/www/analisador
            
            # 2. PUXA O CÓDIGO MAIS RECENTE DO REPOSITÓRIO
            git pull
            
            # 3. RECONSTRÓI E REINICIA OS CONTAINERS DOCKER
            # Isso garante que o código novo seja usado e o ambiente seja atualizado.
            docker-compose up -d --build
            
            echo "Deploy concluído!"